<!DOCTYPE html>
<html>
  <head>
    <title id="slideshow_title">PhotoMap</title>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=10, user-scalable=yes"
    />
    <link rel="icon" type="image/x-icon" href="static/icons/favicon.ico" />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="static/icons/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="static/icons/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="static/icons/favicon-16x16.png"
    />
    <link rel="manifest" href="static/icons/site.webmanifest" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"
    />
    <link rel="stylesheet" type="text/css" href="static/slides.css" />

    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script
      src="https://cdn.plot.ly/plotly-3.0.1.min.js"
      charset="utf-8"
    ></script>
    <script>
      // Pass server data to JavaScript
      window.slideshowConfig = {
          currentDelay: {% if delay %} {{ delay }} {% else %} null {% endif %},
          mode: {% if mode %} "{{ mode }}" {% else %} null {% endif %},
          highWaterMark: {% if highWaterMark %} {{ highWaterMark }} {% else %} null {% endif %},
          album: {% if album %}"{{ album }}"{% else %}null{% endif %}
      };
    </script>
    <script type="module" src="static/main.js"></script>
  </head>

  <body>
    {% include "modules/spinner.html" %}
    {% include "modules/score_slider.html" %} 
    {% include "modules/swiper.html" %}
    {% include "modules/metadata-drawer.html" %}
    {% include "modules/control-panel.html" %}
    {% include "modules/search-panel.html" %}
    {% include "modules/search-dialog.html" %}

    <!-- UMAP Floating Window -->
    <div id="umapFloatingWindow">
      <!-- Titlebar -->
      <div id="umapTitlebar">
        <span>Semantic Map</span>
        <div style="display: flex; align-items: center; gap: 8px">
          <!-- Resizing icons -->
          <button id="umapResizeFullscreen" title="Fullscreen" class="icon-btn">
            <svg width="24" height="24" viewBox="0 0 24 24">
              <rect
                x="2"
                y="2"
                width="20"
                height="20"
                rx="4"
                fill="#fff"
                opacity="0.8"
              />
              <polyline
                points="4,4 20,4 20,20 4,20 4,4"
                stroke="#888"
                stroke-width="2"
                fill="none"
              />
            </svg>
          </button>

          <button id="umapResizeBig" title="Large" class="icon-btn">
            <svg width="28" height="28" viewBox="0 0 28 28">
              <rect
                x="4"
                y="4"
                width="20"
                height="20"
                rx="4"
                fill="#fff"
                opacity="0.8"
              />
            </svg>
          </button>
          <button id="umapResizeMedium" title="Medium" class="icon-btn">
            <svg width="20" height="20" viewBox="0 0 20 20">
              <rect
                x="3"
                y="3"
                width="14"
                height="14"
                rx="3"
                fill="#fff"
                opacity="0.8"
              />
            </svg>
          </button>
          <button id="umapResizeSmall" title="Small" class="icon-btn">
            <svg width="14" height="14" viewBox="0 0 14 14">
              <rect
                x="2"
                y="2"
                width="10"
                height="10"
                rx="2"
                fill="#fff"
                opacity="0.8"
              />
            </svg>
          </button>
          <button id="umapResizeShaded" title="Shaded" class="icon-btn">
            <svg width="18" height="10" viewBox="0 0 18 10">
              <rect
                x="2"
                y="2"
                width="14"
                height="6"
                rx="2"
                fill="#fff"
                opacity="0.8"
              />
            </svg>
          </button>
          <button
            id="umapCloseBtn"
            style="
              background: none;
              border: none;
              color: #fff;
              font-size: 1.5em;
              cursor: pointer;
              margin-left: 8px;
            "
            title="Close"
          >
            &times;
          </button>
        </div>
      </div>
      <!-- Spinner (always visible during loading) -->
      <div
        id="umapSpinner"
        style="
          display: none;
          position: absolute;
          left: 50%;
          top: 50%;
          transform: translate(-50%, -50%);
          z-index: 1000;
        "
      >
        <div class="umap-spinner"></div>
      </div>

      <!-- All other content hidden until plot is ready -->
      <div id="umapContent" style="display: none">
        <!-- Plotly Plot -->
        <div id="umapPlot"></div>

        <!-- Controls Row: EPS spinner and Color Mode -->
        <div
          style="
            display: flex;
            flex-direction: row;
            gap: 24px;
            justify-content: center;
            align-items: flex-start;
            margin-top: 12px;
          "
        >
          <!-- EPS Spinner Container -->
          <div id="umapEpsContainer" style="display: none; padding: 8px">
            <label for="umapEpsSpinner">Cluster Strength</label>
            <input
              type="number"
              id="umapEpsSpinner"
              min="0.01"
              max="1.0"
              step="0.01"
              value="0.1"
              style="width: 60px"
            />
          </div>

          <!-- Colorization Mode Controls (vertical column) -->
          <div
            id="umapColorModeContainer"
            style="display: flex; flex-direction: column; margin-bottom: 12px"
          >
            <label style="display: flex; align-items: center; gap: 8px">
              <input
                type="checkbox"
                id="umapHighlightSelection"
                style="margin-right: 6px"
              />
              Highlight selection
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Overlay -->
    <div id="settingsOverlay" class="modal-overlay">
      <div class="modal-content settings-modal">
        <button
          id="closeSettingsBtn"
          class="modal-close"
          title="Close settings"
        >
          ✖
        </button>

        <div class="settings-header">
          <span id="slideshowSettingsLabel">PhotoMap Settings</span>
        </div>

        <div class="settings-main">
          <!-- Left column: Slower/Faster/Interval -->
          <div class="delay-controls">
            <div id="delayLabel">Image Change Interval</div>

            <div class="delay-control-buttons">
              <button id="fasterBtn" title="Faster">&#9664;</button>
              <span id="delayValue">10</span>
              <button id="slowerBtn" title="Slower">&#9654;</button>
            </div>
          </div>

          <!-- Right column: Mode controls -->
          <div id="modeControls">
            <div id="modeLabel">Image Browse Order:</div>

            <div id="modeRadioGroup">
              <label
                ><input
                  type="radio"
                  id="modeRandom"
                  name="mode"
                  value="random"
                  checked
                />
                Random</label
              >
              <label
                ><input
                  type="radio"
                  id="modeChronological"
                  name="mode"
                  value="chronological"
                />
                Chronological</label
              >
            </div>
          </div>
        </div>

        <!-- Settings rows -->
        <div class="setting-row">
          <label for="highWaterMarkInput">Max Images in History:</label>
          <div class="setting-input-container">
            <input
              id="highWaterMarkInput"
              type="number"
              min="2"
              max="100"
              value="10"
            />
          </div>
        </div>

        <!-- Row for control panel text visibility -->
        <div class="setting-row">
          <label for="showControlPanelTextCheckbox">Show Button Labels:</label>
          <div class="setting-input-container">
            <input type="checkbox" id="showControlPanelTextCheckbox" />
          </div>
        </div>

        <!-- Input for the LocationIQ API Key -->
        <div class="setting-row">
          <label for="locationiqApiKeyInput">LocationIQ Map API Key:</label>
          <div class="setting-input-container">
            <form
              id="locationiqApiKeyForm"
              autocomplete="off"
              style="margin: 0"
            >
              <input
                type="password"
                id="locationiqApiKeyInput"
                placeholder="Enter your LocationIQ API key (optional)"
                autocomplete="pk-xxxxxxxx"
              />
            </form>
            <small
              style="
                color: #666;
                font-size: 0.85em;
                display: block;
                margin-top: 4px;
              "
            >
              Optional: Enables location names and maps in EXIF data.
              <a
                href="https://locationiq.com"
                target="_blank"
                style="color: #007bff"
                >Get a free key</a
              >
            </small>
          </div>
        </div>

        <div class="setting-row">
          <label for="albumSelect">Album:</label>
          <div class="album-selector-group">
            <select id="albumSelect">
              <option value="">Loading albums...</option>
            </select>
            <button id="manageAlbumsBtn" class="btn-primary">
              Manage Albums
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Album Management Overlay -->
    <div id="albumManagementOverlay" class="modal-overlay album-management">
      <div
        class="modal-content album-management-modal"
        id="albumManagementContent"
      >
        <!-- Header with Add Album Button (fixed) -->
        <div class="album-header">
          <h2>Album Management</h2>
          <div class="header-buttons">
            <button id="showAddAlbumBtn" class="btn-primary">
              + Add Album
            </button>
            <button
              id="closeAlbumManagementBtn"
              class="modal-close"
              title="Close"
            >
              ✖
            </button>
          </div>
        </div>

        <!-- Add New Album Section (fixed, if desired) -->
        <div id="addAlbumSection" class="add-album-section">
          <div class="section-header">
            <h3>Add New Album</h3>
            <button id="cancelAddAlbumBtn" class="cancel-btn" title="Cancel">
              ✖
            </button>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label>Album Key</label>
              <input
                id="newAlbumKey"
                type="text"
                placeholder="e.g., vacation_2024"
              />
            </div>
            <div class="form-group">
              <label>Display Name</label>
              <input
                id="newAlbumName"
                type="text"
                placeholder="e.g., Vacation 2024"
              />
            </div>
          </div>

          <div class="form-group">
            <label>Description</label>
            <input
              id="newAlbumDescription"
              type="text"
              placeholder="Optional description"
            />
          </div>

          <div class="form-group">
            <label>Image Paths (one per line)</label>
            <textarea
              id="newAlbumPaths"
              placeholder="/path/to/images&#10;/another/path/to/images"
              rows="3"
            ></textarea>
          </div>

          <div class="form-buttons">
            <button id="addAlbumBtn" class="btn-primary">Add Album</button>
            <button id="cancelAddAlbumBtn2" class="btn-secondary">
              Cancel
            </button>
          </div>
        </div>

        <!-- Scrollable Albums Section -->
        <div
          id="albumsScrollContainer"
          style="max-height: 60vh; overflow-y: auto"
        >
          <div id="existingAlbumsSection">
            <h3>Albums</h3>
            <div id="albumsList">
              <!-- Albums will be populated here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Album Card Template -->
    <template id="albumCardTemplate">
      <div class="album-card">
        <div class="album-info">
          <div class="album-details">
            <div class="album-text">
              <h4 class="album-name"></h4>
              <div class="album-key"></div>
              <div class="album-description"></div>
              <div class="album-paths"></div>
            </div>
            <div class="indexing-section">
              <!-- Index Status and Button -->
              <div class="index-controls">
                <div class="index-status">Ready to index</div>
                <button class="create-index-btn btn-index">Update Index</button>
                <button class="cancel-index-btn btn-cancel">Cancel</button>
              </div>
              <!-- Progress Container -->
              <div class="progress-container">
                <div class="progress-bar-wrapper">
                  <div class="progress-bar-track">
                    <div class="progress-bar"></div>
                    <div class="progress-bar-shimmer"></div>
                  </div>
                  <div class="progress-text">0%</div>
                </div>
                <div class="estimated-time"></div>
              </div>
            </div>
            <div class="action-buttons vertical">
              <button class="edit-album-btn btn-edit">Edit</button>
              <button class="delete-album-btn btn-delete">Delete</button>
            </div>
          </div>
        </div>
        <!-- Edit Form -->
        <div class="edit-form">
          <h5>Edit Album</h5>
          <div class="form-grid">
            <div class="form-group">
              <label>Display Name</label>
              <input class="edit-album-name" type="text" />
            </div>
            <div class="form-group">
              <label>Description</label>
              <input class="edit-album-description" type="text" />
            </div>
          </div>
          <div class="form-group">
            <label>Image Paths (one per line)</label>
            <textarea class="edit-album-paths" rows="3"></textarea>
          </div>
          <div class="form-buttons">
            <button class="save-album-btn btn-primary">Save Changes</button>
            <button class="cancel-edit-btn btn-secondary">Cancel</button>
          </div>
        </div>
      </div>
    </template>

    <!-- Metadata Modal -->
    <div id="metadataModal" class="modal-overlay">
      <div class="modal-content">
        <button id="closeMetadataModalBtn" class="modal-close" title="Close">
          ✖
        </button>
        <h3 style="color: #faea0e; margin-top: 0">Image Metadata (JSON)</h3>
        <textarea
          id="metadataTextArea"
          readonly
          style="
            width: 100%;
            height: 300px;
            font-family: monospace;
            font-size: 1em;
            padding: 1em;
            border-radius: 8px;
            background: #222;
            color: #fff;
            border: 1px solid #888;
          "
        ></textarea>
      </div>
    </div>
  </body>
</html>
